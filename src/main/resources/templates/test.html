<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæµ‹è¯• -Excel API </title>
    <link rel="stylesheet" th:href="@{/css/admin.css}">
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>
    
    <div class="container">
        <h1>ğŸ§ª APIæµ‹è¯•</h1>
        
        <div class="card">
            <h2>åŸºç¡€é…ç½®</h2>
            <div class="form-group">
                <label for="apiToken">é€‰æ‹©Token *</label>
                <select id="apiToken" class="form-control">
                    <option value="">è¯·é€‰æ‹©Token</option>
                    <option th:each="token : ${tokens}" th:value="${token.token}" th:text="${token.name}"></option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="apiEndpoint">APIæ¥å£ *</label>
                <select id="apiEndpoint" class="form-control" onchange="updateExample()">
                    <optgroup label="ğŸ“ Excel æ“ä½œ">
                        <option value="write">å†™å…¥Excel</option>
                        <option value="read">è¯»å–Excel</option>
                        <option value="operation">å†™å…¥å¹¶è¯»å–ï¼ˆç»„åˆæ“ä½œï¼‰</option>
                    </optgroup>
                    <optgroup label="ğŸ“ æ–‡ä»¶ç®¡ç†">
                        <option value="upload">ä¸Šä¼ æ–‡ä»¶</option>
                        <option value="download">ä¸‹è½½æ–‡ä»¶</option>
                    </optgroup>
                    <optgroup label="ğŸ“„ æ¨¡æ¿åŠŸèƒ½">
                        <option value="templateGenerate">æ¨¡æ¿ç”Ÿæˆï¼ˆè¿”å›æ–‡ä»¶åï¼‰</option>
                        <option value="templateDownload">æ¨¡æ¿å¡«å……å¹¶ä¸‹è½½</option>
                    </optgroup>
                    <optgroup label="ğŸ”§ ç³»ç»Ÿ">
                        <option value="health">å¥åº·æ£€æŸ¥</option>
                    </optgroup>
                </select>
            </div>
        </div>
        
        <div class="card">
            <h2>æµ‹è¯•ç”¨ä¾‹</h2>
            
            <div class="form-group">
                <label for="excelFile">é€‰æ‹©Excelæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</label>
                <select id="excelFile" class="form-control" onchange="insertFileName()">
                    <option value="">é€‰æ‹©å·²ä¸Šä¼ çš„æ–‡ä»¶</option>
                    <option th:each="file : ${files}" th:value="${file}" th:text="${file}"></option>
                </select>
            </div>
            
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸï¼ˆä»…åœ¨uploadæ¥å£æ—¶æ˜¾ç¤ºï¼‰ -->
            <div id="uploadArea" class="form-group" style="display: none;">
                <label for="uploadFile">é€‰æ‹©æ–‡ä»¶ä¸Šä¼  *</label>
                <input type="file" id="uploadFile" class="form-control" accept=".xlsx,.xls">
            </div>
            
            <!-- ä¸‹è½½æ–‡ä»¶åï¼ˆä»…åœ¨downloadæ¥å£æ—¶æ˜¾ç¤ºï¼‰ -->
            <div id="downloadArea" class="form-group" style="display: none;">
                <label for="downloadFileName">è¦ä¸‹è½½çš„æ–‡ä»¶å *</label>
                <input type="text" id="downloadFileName" class="form-control" placeholder="ä¾‹å¦‚: test.xlsx">
            </div>
            
            <div id="jsonArea" class="form-group">
                <label for="requestBody">è¯·æ±‚ä½“ï¼ˆJSONï¼‰</label>
                <textarea id="requestBody" class="form-control" rows="15"></textarea>
            </div>
            
            <button class="btn btn-primary" onclick="sendRequest()">ğŸš€ å‘é€è¯·æ±‚</button>
            <button class="btn btn-secondary" onclick="updateExample()">ğŸ“ åŠ è½½ç¤ºä¾‹</button>
        </div>
        
        <div class="card" id="responseCard" style="display: none;">
            <h2>å“åº”ç»“æœ</h2>
            <div id="responseStatus"></div>
            <div id="responseBody" class="test-result"></div>
        </div>
    </div>
    
    <script>
        // æ‰€æœ‰æ¥å£çš„ç¤ºä¾‹æ•°æ®
        const examples = {
            write: {
                fileName: 'test.xlsx',
                sheetName: 'Sheet1',
                cells: [
                    {cellAddress: 'A1', value: 'å§“å', valueType: 'STRING'},
                    {cellAddress: 'B1', value: 'åˆ†æ•°', valueType: 'STRING'},
                    {cellAddress: 'A2', value: 'å¼ ä¸‰', valueType: 'STRING'},
                    {cellAddress: 'B2', value: 85, valueType: 'NUMBER'},
                    {cellAddress: 'A3', value: 'æå››', valueType: 'STRING'},
                    {cellAddress: 'B3', value: 92, valueType: 'NUMBER'},
                    {cellAddress: 'B4', value: '=AVERAGE(B2:B3)', valueType: 'FORMULA'},
                    {sheetName: 'Sheet2', cellAddress: 'A1', value: 'ç»Ÿè®¡', valueType: 'STRING'},
                    {sheetName: 'Sheet2', cellAddress: 'B1', value: '=Sheet1!B4', valueType: 'FORMULA'}
                ]
            },
            read: {
                fileName: 'test.xlsx',
                sheetName: 'Sheet1',
                cells: [
                    {cellAddress: 'A1'},
                    {cellAddress: 'A2'},
                    {cellAddress: 'B2'},
                    {cellAddress: 'B4'},
                    {sheetName: 'Sheet2', cellAddress: 'A1'},
                    {sheetName: 'Sheet2', cellAddress: 'B1'}
                ],
                readFormula: false
            },
            operation: {
                fileName: 'test.xlsx',
                writeRequest: {
                    cells: [
                        {sheetName: 'é”€å”®æ•°æ®', cellAddress: 'A1', value: 'äº§å“', valueType: 'STRING'},
                        {sheetName: 'é”€å”®æ•°æ®', cellAddress: 'B1', value: 50000, valueType: 'NUMBER'},
                        {sheetName: 'æˆæœ¬æ•°æ®', cellAddress: 'A1', value: 'æˆæœ¬', valueType: 'STRING'},
                        {sheetName: 'æˆæœ¬æ•°æ®', cellAddress: 'B1', value: 30000, valueType: 'NUMBER'},
                        {sheetName: 'åˆ©æ¶¦ç»Ÿè®¡', cellAddress: 'A1', value: 'å‡€åˆ©æ¶¦', valueType: 'STRING'},
                        {sheetName: 'åˆ©æ¶¦ç»Ÿè®¡', cellAddress: 'B1', value: '=é”€å”®æ•°æ®!B1-æˆæœ¬æ•°æ®!B1', valueType: 'FORMULA'}
                    ]
                },
                readRequest: {
                    cells: [
                        {sheetName: 'é”€å”®æ•°æ®', cellAddress: 'B1'},
                        {sheetName: 'æˆæœ¬æ•°æ®', cellAddress: 'B1'},
                        {sheetName: 'åˆ©æ¶¦ç»Ÿè®¡', cellAddress: 'B1'}
                    ],
                    readFormula: false
                }
            },
            upload: {
                note: 'è¯·ä½¿ç”¨ä¸Šæ–¹çš„æ–‡ä»¶é€‰æ‹©å™¨é€‰æ‹©è¦ä¸Šä¼ çš„Excelæ–‡ä»¶'
            },
            download: {
                note: 'è¯·åœ¨ä¸Šæ–¹è¾“å…¥è¦ä¸‹è½½çš„æ–‡ä»¶åï¼Œä¾‹å¦‚: test.xlsx'
            },
            templateGenerate: {
                templateFileName: 'template.xlsx',
                outputFileName: 'report_2024_10.xlsx',
                cells: [
                    {sheetName: 'æŠ¥å‘Šé¦–é¡µ', cellAddress: 'A1', value: '2024å¹´10æœˆæŠ¥å‘Š', valueType: 'STRING'},
                    {sheetName: 'æ•°æ®è¯¦æƒ…', cellAddress: 'B5', value: 12345.67, valueType: 'NUMBER'},
                    {sheetName: 'ç»Ÿè®¡æ±‡æ€»', cellAddress: 'C10', value: '=æ•°æ®è¯¦æƒ…!B5*1.1', valueType: 'FORMULA'}
                ]
            },
            templateDownload: {
                templateFileName: 'template.xlsx',
                cells: [
                    {sheetName: 'æŠ¥å‘Šé¦–é¡µ', cellAddress: 'A1', value: 'å³æ—¶æŠ¥å‘Š', valueType: 'STRING'},
                    {sheetName: 'æ•°æ®è¯¦æƒ…', cellAddress: 'B5', value: 999, valueType: 'NUMBER'},
                    {sheetName: 'ç»Ÿè®¡æ±‡æ€»', cellAddress: 'A1', value: '=æ•°æ®è¯¦æƒ…!B5*2', valueType: 'FORMULA'}
                ]
            },
            health: {
                note: 'å¥åº·æ£€æŸ¥æ¥å£æ— éœ€è¯·æ±‚ä½“ï¼Œç›´æ¥å‘é€GETè¯·æ±‚'
            }
        };
        
        // APIæ¥å£é…ç½®
        const apiConfig = {
            write: { url: '/api/excel/write', method: 'POST', needToken: true, needJson: true },
            read: { url: '/api/excel/read', method: 'POST', needToken: true, needJson: true },
            operation: { url: '/api/excel/operation', method: 'POST', needToken: true, needJson: true },
            upload: { url: '/api/excel/upload', method: 'POST', needToken: true, needJson: false, isUpload: true },
            download: { url: '/api/excel/download/', method: 'GET', needToken: true, needJson: false, isDownload: true },
            templateGenerate: { url: '/api/excel/template/generate', method: 'POST', needToken: true, needJson: true },
            templateDownload: { url: '/api/excel/template/fill-and-download', method: 'POST', needToken: true, needJson: true, isDownload: true },
            health: { url: '/api/excel/health', method: 'GET', needToken: false, needJson: false }
        };
        
        // æ›´æ–°ç¤ºä¾‹å’ŒUI
        function updateExample() {
            const endpoint = document.getElementById('apiEndpoint').value;
            const exampleData = examples[endpoint];
            const config = apiConfig[endpoint];
            
            // æ›´æ–°è¯·æ±‚ä½“
            document.getElementById('requestBody').value = JSON.stringify(exampleData, null, 2);
            
            // æ˜¾ç¤º/éšè—ç›¸å…³åŒºåŸŸ
            document.getElementById('uploadArea').style.display = config.isUpload ? 'block' : 'none';
            document.getElementById('downloadArea').style.display = config.isDownload && endpoint === 'download' ? 'block' : 'none';
            document.getElementById('jsonArea').style.display = config.needJson ? 'block' : 'none';
            
            // æ¸…ç©ºå“åº”åŒºåŸŸ
            document.getElementById('responseCard').style.display = 'none';
        }
        
        // æ’å…¥æ–‡ä»¶ååˆ°JSON
        function insertFileName() {
            const fileName = document.getElementById('excelFile').value;
            if (!fileName) return;
            
            const endpoint = document.getElementById('apiEndpoint').value;
            const config = apiConfig[endpoint];
            
            if (endpoint === 'download') {
                document.getElementById('downloadFileName').value = fileName;
            } else if (config.needJson) {
                try {
                    const json = JSON.parse(document.getElementById('requestBody').value);
                    json.fileName = fileName;
                    document.getElementById('requestBody').value = JSON.stringify(json, null, 2);
                } catch (e) {
                    // å¿½ç•¥JSONè§£æé”™è¯¯
                }
            }
        }
        
        // å‘é€è¯·æ±‚
        async function sendRequest() {
            const endpoint = document.getElementById('apiEndpoint').value;
            const config = apiConfig[endpoint];
            const token = document.getElementById('apiToken').value;
            
            // æ£€æŸ¥Tokenï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (config.needToken && !token) {
                alert('è¯·é€‰æ‹©Token');
                return;
            }
            
            try {
                let response, responseBody, contentType;
                const startTime = Date.now();
                
                // æ ¹æ®ä¸åŒçš„æ¥å£ç±»å‹å¤„ç†è¯·æ±‚
                if (config.isUpload) {
                    // æ–‡ä»¶ä¸Šä¼ 
                    const fileInput = document.getElementById('uploadFile');
                    if (!fileInput.files[0]) {
                        alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    
                    response = await fetch(config.url, {
                        method: config.method,
                        headers: {'X-API-Token': token},
                        body: formData
                    });
                    
                    responseBody = await response.text();
                    try {
                        responseBody = JSON.stringify(JSON.parse(responseBody), null, 2);
                    } catch (e) {}
                    
                } else if (config.isDownload) {
                    // æ–‡ä»¶ä¸‹è½½
                    let url = config.url;
                    if (endpoint === 'download') {
                        const fileName = document.getElementById('downloadFileName').value;
                        if (!fileName) {
                            alert('è¯·è¾“å…¥è¦ä¸‹è½½çš„æ–‡ä»¶å');
                            return;
                        }
                        url += fileName;
                    }
                    
                    const headers = {'X-API-Token': token};
                    
                    if (endpoint === 'templateDownload') {
                        // æ¨¡æ¿ä¸‹è½½éœ€è¦POST JSON
                        headers['Content-Type'] = 'application/json';
                        response = await fetch(url, {
                            method: config.method,
                            headers: headers,
                            body: document.getElementById('requestBody').value
                        });
                    } else {
                        // æ™®é€šä¸‹è½½
                        response = await fetch(url, {
                            method: config.method,
                            headers: headers
                        });
                    }
                    
                    if (response.ok) {
                        // ä¸‹è½½æ–‡ä»¶
                        const blob = await response.blob();
                        const downloadUrl = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = endpoint === 'download' ? 
                            document.getElementById('downloadFileName').value : 
                            'template_filled.xlsx';
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        window.URL.revokeObjectURL(downloadUrl);
                        
                        responseBody = `æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼\næ–‡ä»¶å¤§å°: ${(blob.size / 1024).toFixed(2)} KB`;
                    } else {
                        responseBody = await response.text();
                    }
                    
                } else {
                    // æ™®é€šJSONè¯·æ±‚
                    const headers = {};
                    if (config.needToken) {
                        headers['X-API-Token'] = token;
                    }
                    if (config.needJson) {
                        headers['Content-Type'] = 'application/json';
                    }
                    
                    response = await fetch(config.url, {
                        method: config.method,
                        headers: headers,
                        body: config.needJson ? document.getElementById('requestBody').value : undefined
                    });
                    
                    responseBody = await response.text();
                    try {
                        responseBody = JSON.stringify(JSON.parse(responseBody), null, 2);
                    } catch (e) {}
                }
                
                const duration = Date.now() - startTime;
                
                // æ˜¾ç¤ºå“åº”
                document.getElementById('responseCard').style.display = 'block';
                document.getElementById('responseStatus').innerHTML = 
                    `<div class="alert ${response.ok ? 'alert-success' : 'alert-error'}">
                        <strong>çŠ¶æ€ç :</strong> ${response.status} ${response.statusText} | 
                        <strong>è€—æ—¶:</strong> ${duration}ms | 
                        <strong>æ–¹æ³•:</strong> ${config.method} ${config.url}
                    </div>`;
                document.getElementById('responseBody').textContent = responseBody;
                
            } catch (error) {
                document.getElementById('responseCard').style.display = 'block';
                document.getElementById('responseStatus').innerHTML = 
                    '<div class="alert alert-error"><strong>è¯·æ±‚å¤±è´¥</strong></div>';
                document.getElementById('responseBody').textContent = 
                    'Error: ' + error.message + '\n\n' + error.stack;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            updateExample();
        });
    </script>
</body>
</html>

